<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>koaç®€ä»‹ | lcoderçš„åšå®¢</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="lcoder,å‰ç«¯,è®¾è®¡,å‰ç«¯å¼€å‘,ç”¨æˆ·ä½“éªŒ,è®¾è®¡,css3,design,nodejs,JavaScript,html5" />
  

  <meta name="description" content="koaç®€ä»‹åˆè¯•koaï¼Œçœ‹äº†ä¸‹å®˜ç½‘ä»‹ç»ï¼Œè®°å½•ä¸€ä¸‹å­¦ä¹ å¿ƒå¾—ã€‚
koaæ˜¯è‡´åŠ›äºæˆä¸ºä¸€ä¸ªæ›´å°ã€æ›´å¥å£®ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›çš„ Web æ¡†æ¶ã€‚è·Ÿexpressç›¸æ¯”ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ç”¨æ–°çš„async function è§£å†³äº†å›è°ƒå‡½æ•°çš„å™©æ¢¦ã€‚
æ¯”å¦‚ç”¨expresså®ç°ä¸€ä¸ªè®¡ç®—ç¨‹åºå¤„ç†æ—¶é—´çš„åŠŸèƒ½ï¼Œç”¨expresså†™æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
1234567891011var express = require(&apos;express&apos;);">
<meta property="og:type" content="article">
<meta property="og:title" content="koaç®€ä»‹">
<meta property="og:url" content="http://www.maotingfeng.me/2017/03/26/coæ¨¡å—æºç è§£æ/index.html">
<meta property="og:site_name" content="lcoderçš„åšå®¢">
<meta property="og:description" content="koaç®€ä»‹åˆè¯•koaï¼Œçœ‹äº†ä¸‹å®˜ç½‘ä»‹ç»ï¼Œè®°å½•ä¸€ä¸‹å­¦ä¹ å¿ƒå¾—ã€‚
koaæ˜¯è‡´åŠ›äºæˆä¸ºä¸€ä¸ªæ›´å°ã€æ›´å¥å£®ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›çš„ Web æ¡†æ¶ã€‚è·Ÿexpressç›¸æ¯”ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ç”¨æ–°çš„async function è§£å†³äº†å›è°ƒå‡½æ•°çš„å™©æ¢¦ã€‚
æ¯”å¦‚ç”¨expresså®ç°ä¸€ä¸ªè®¡ç®—ç¨‹åºå¤„ç†æ—¶é—´çš„åŠŸèƒ½ï¼Œç”¨expresså†™æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
1234567891011var express = require(&apos;express&apos;);">
<meta property="og:updated_time" content="2017-03-26T15:14:41.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="koaç®€ä»‹">
<meta name="twitter:description" content="koaç®€ä»‹åˆè¯•koaï¼Œçœ‹äº†ä¸‹å®˜ç½‘ä»‹ç»ï¼Œè®°å½•ä¸€ä¸‹å­¦ä¹ å¿ƒå¾—ã€‚
koaæ˜¯è‡´åŠ›äºæˆä¸ºä¸€ä¸ªæ›´å°ã€æ›´å¥å£®ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›çš„ Web æ¡†æ¶ã€‚è·Ÿexpressç›¸æ¯”ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ç”¨æ–°çš„async function è§£å†³äº†å›è°ƒå‡½æ•°çš„å™©æ¢¦ã€‚
æ¯”å¦‚ç”¨expresså®ç°ä¸€ä¸ªè®¡ç®—ç¨‹åºå¤„ç†æ—¶é—´çš„åŠŸèƒ½ï¼Œç”¨expresså†™æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
1234567891011var express = require(&apos;express&apos;);">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=028c63b1" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  

</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">ç›’å­</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">ç›’å­</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            åšå®¢
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            target="_self"
            >
            åˆ†ç±»
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            æ ‡ç­¾
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            å‹é“¾
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            å…³äº
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/RSS/atom.xml"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            æœç´¢
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#koaç®€ä»‹"><span class="toc-text">koaç®€ä»‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#koaçš„ä»£ç çº§è”"><span class="toc-text">koaçš„ä»£ç çº§è”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koaé…ç½®"><span class="toc-text">Koaé…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-listen-â€¦-ç›‘å¬ç«¯å£"><span class="toc-text">app.listen( â€¦ )ç›‘å¬ç«¯å£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-callback"><span class="toc-text">app.callback()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-use-middleWare"><span class="toc-text">app.use(middleWare)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#app-context"><span class="toc-text">app.context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#é”™è¯¯å¤„ç†"><span class="toc-text">é”™è¯¯å¤„ç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Context"><span class="toc-text">Context</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Request"><span class="toc-text">Request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Response"><span class="toc-text">Response</span></a></li></ol></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-coæ¨¡å—æºç è§£æ" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">koaç®€ä»‹</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.03.26</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>maotingfeng</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <h2 id="koaç®€ä»‹"><a href="#koaç®€ä»‹" class="headerlink" title="koaç®€ä»‹"></a>koaç®€ä»‹</h2><p>åˆè¯•koaï¼Œçœ‹äº†ä¸‹å®˜ç½‘ä»‹ç»ï¼Œè®°å½•ä¸€ä¸‹å­¦ä¹ å¿ƒå¾—ã€‚</p>
<p>koaæ˜¯è‡´åŠ›äºæˆä¸ºä¸€ä¸ªæ›´å°ã€æ›´å¥å£®ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›çš„ Web æ¡†æ¶ã€‚è·Ÿexpressç›¸æ¯”ï¼Œæœ€æ ¸å¿ƒçš„éƒ¨åˆ†å°±æ˜¯ç”¨æ–°çš„async function è§£å†³äº†å›è°ƒå‡½æ•°çš„å™©æ¢¦ã€‚</p>
<p>æ¯”å¦‚ç”¨expresså®ç°ä¸€ä¸ªè®¡ç®—ç¨‹åºå¤„ç†æ—¶é—´çš„åŠŸèƒ½ï¼Œç”¨expresså†™æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.use( <span class="string">'/'</span> , <span class="function"><span class="keyword">function</span>(<span class="params"> req , res , next </span>)</span>&#123;</div><div class="line">  req.startTime = <span class="keyword">new</span> <span class="built_in">Date</span>() ;</div><div class="line">  next() ;</div><div class="line">&#125; ) ;</div><div class="line"></div><div class="line">app.use( <span class="string">'/'</span> , <span class="function"><span class="keyword">function</span>(<span class="params"> req , res , next </span>)</span>&#123;</div><div class="line">  req.endTime = <span class="keyword">new</span> <span class="built_in">Date</span>() ;</div><div class="line">  res.end( <span class="string">'time diff: '</span> + ( req.startTime - req.endTime ) + <span class="string">'ms'</span> ) ;</div><div class="line">&#125; ) ;</div></pre></td></tr></table></figure>
<p>expressçš„ä¸­é—´ä»¶å½¢å¼ï¼Œéœ€è¦æ¯ä¸ªä¸­é—´ä»¶æ‰‹åŠ¨è°ƒç”¨nextå‡½æ•°ï¼ŒæŠŠæ‰§è¡Œæƒé™ç§»äº¤åˆ°ä¸‹ä¸€ä¸ªæ³¨å†Œçš„ä¸­é—´ä»¶ã€‚</p>
<p>å¦‚æœç”¨koaæ¥å†™ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>( <span class="string">'koa'</span> ) ;</div><div class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</div><div class="line">app.use(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> startTime = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">  <span class="keyword">await</span> next();</div><div class="line">  <span class="keyword">const</span> timeDiff = <span class="keyword">new</span> <span class="built_in">Date</span>() - startTime;</div><div class="line">  ctx.body = <span class="string">`time diff: <span class="subst">$&#123;timeDiff&#125;</span>ms`</span>;</div><div class="line">&#125;);</div><div class="line">app.listen(<span class="number">3001</span>);</div></pre></td></tr></table></figure>
<p>ç›¸å¯¹è€Œè¨€ï¼Œä»£ç ç®€å•äº†å¾ˆå¤šã€‚æƒ³è¦å­¦ä¹ koaï¼Œå…ˆè¦å­¦ä¹ ä¸€ä¸‹åŸºç¡€çŸ¥è¯†ç‚¹ï¼Œasyncå‡½æ•°ã€‚</p>
<h3 id="koaçš„ä»£ç çº§è”"><a href="#koaçš„ä»£ç çº§è”" class="headerlink" title="koaçš„ä»£ç çº§è”"></a>koaçš„ä»£ç çº§è”</h3><p>ä»£ç çº§è”æ˜¯é€šè¿‡asyncå‡½æ•°å®ç°çš„ï¼ˆKoa v2.x ç§»é™¤äº†å†…ç½®çš„ Generator æ”¯æŒï¼Œä½¿ç”¨ async å‡½æ•°æ›¿ä»£ï¼‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸‹asyncå‡½æ•°ï¼Œè¯­æ³•å¾ˆç®€å•:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncFunc</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">// å‡½æ•°ä½“</span></div><div class="line">  <span class="keyword">var</span> data = <span class="keyword">await</span> fetchSomeThing() ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>asyncå‡½æ•°è¿”å›ä¸€ä¸ªpromiseå¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨thenæ–¹æ³•æ·»åŠ å›è°ƒå‡½æ•°ã€‚å½“å‡½æ•°ä½“æ‰§è¡Œçš„æ—¶å€™ï¼Œé‡åˆ°awaitçš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œåé¢çš„è¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼å¯ä»¥æ˜¯åŸå§‹å€¼ç±»å‹æˆ–è€…è¿”å›Promiseå¯¹è±¡ã€‚å¦‚æœæ˜¯ä¸ªå¼‚æ­¥è¡¨è¾¾å¼çš„è¯ï¼Œjavascriptä¼šä¸­æ–­æœ¬æ¬¡æ‰§è¡Œï¼Œæ‰§è¡Œå…¶ä»–å†…å®¹ã€‚ç­‰å¼‚æ­¥æ‰§è¡Œç»“æŸï¼Œä¼šè¿”å›åˆ°ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘æƒ³ä¸­æ–­ä¸¤ç§’é’Ÿï¼Œè¿”å›ä¸€ä¸ªhello worldï¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">delayTwoSeconds</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>( ( resolve , reject )=&gt;&#123;</div><div class="line">        setTimeout( resolve.bind(<span class="literal">null</span>,<span class="string">'hello world!'</span>) , <span class="number">2000</span> ) ;</div><div class="line">    &#125; ) ;</div><div class="line">    <span class="keyword">return</span> result</div><div class="line">&#125;</div><div class="line">delayTwoSeconds().then( data=&gt;<span class="built_in">console</span>.log( data ) ) ;  <span class="comment">// 2måï¼Œæ§åˆ¶å°ï¼šhello world!</span></div></pre></td></tr></table></figure>
<p>å½“æ‰§è¡Œçš„æ—¶å€™ï¼Œresultå¹¶ä¸ä¼šç«‹å³è¿”å›ï¼Œè€Œæ˜¯ç­‰å¾…2ç§’ï¼Œç„¶åè¿”å›ã€‚</p>
<p>ç”¨asyncå‡½æ•°æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p>
<ul>
<li>ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ‰§è¡Œè¿‡ç¨‹æ˜äº†ï¼Œé¿å…äº†å›è°ƒåµŒå¥—çš„ä»£ç </li>
<li>å‡½æ•°çš„ä½œç”¨åŸŸå¾—ä»¥ä¿å­˜ï¼Œä¸å†ç”¨callback( data ) å‡½æ•°ä¼ å‚</li>
<li>æ˜“äºé”™è¯¯çš„æ•è·</li>
</ul>
<p>ç¬¬ä¸‰ç‚¹,æ€ä¹ˆé”™è¯¯æ•è·ï¼Ÿå¹³å¸¸å¦‚æœå¼‚æ­¥å›è°ƒå‡½æ•°æ‰§è¡Œçš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨callbackä¸­ï¼Œæ•è·é”™è¯¯ , å› ä¸ºå½“æ‰§è¡Œå¼‚æ­¥æ“ä½œçš„æ—¶å€™ï¼Œå¼‚æ­¥å‡½æ•°ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œjavascriptæ‰§è¡Œå…¶ä»–å†…å®¹çš„æ—¶å€™ï¼Œå‡½æ•°çš„èµ„æºä¼šè¢«åƒåœ¾å›æ”¶ï¼Œç­‰äº‹ä»¶æœºåˆ¶é€šçŸ¥å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼ŒåŸæ¥çš„èµ„æºæ—©å·²ä¸åœ¨ï¼Œæ‰€ä»¥å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œä¹Ÿæ˜¯åªèƒ½é€šè¿‡å‡½æ•°ä¼ å‚ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span>(<span class="params"> error , data </span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>( error ) &#123; <span class="keyword">throw</span> error ; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è€Œä½¿ç”¨asyncå‡½æ•°ï¼Œå› ä¸ºå‡½æ•°åªæ˜¯æš‚åœæ‰§è¡Œï¼Œé‡Œé¢çš„å˜é‡å¹¶ä¸ä¼šè¢«å›æ”¶ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­ä½¿ç”¨ã€‚</p>
<p>koaåˆ©ç”¨äº†asyncçš„ç‰¹æ€§ï¼Œè®©åµŒå¥—ä¸­é—´ä»¶æ‰§è¡Œä¹‹åï¼Œä¸ç”¨é€šè¿‡ç»‘å®šå…¨å±€å˜é‡ï¼Œæˆ–è€…åœ¨<code>requestå¯¹è±¡</code>ä¸Šç»‘å®šå±æ€§æ¥ä¼ å‚äº†ï¼Œç›´æ¥åœ¨å‡½æ•°ä½“é‡Œé¢ç”¨ä¹‹å‰å®šä¹‰çš„å˜é‡ï¼Œæ–¹ä¾¿äº†å¾ˆå¤šã€‚koaçš„asyncè°ƒç”¨æœºåˆ¶çš„ä»‹ç»å®Œæ¯•ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨apiçš„è¯´æ˜ã€‚</p>
<h3 id="Koaé…ç½®"><a href="#Koaé…ç½®" class="headerlink" title="Koaé…ç½®"></a>Koaé…ç½®</h3><p>koaçš„åº”ç”¨ç¨‹åºé…ç½®é»˜è®¤åœ¨appå®ä¾‹ä¸Šï¼Œç›®å‰æ”¯æŒ</p>
<ul>
<li>app.env é»˜è®¤ä¸º<code>NODE_ENV</code>ï¼Œå¦‚æœæ²¡æœ‰é…ç½®çš„è¯ï¼Œä¸º<code>&quot;development&quot;</code></li>
<li>app.proxy å½“è®¾ç½®ä¸ºtrueæ—¶ï¼Œæ”¯æŒ X-Forwarded-Host</li>
<li>app.subdomainOffset å­åŸŸååç§»é‡ï¼Œå±æ€§é»˜è®¤ä¸º2ï¼Œå¦‚åŸŸåâ€œtobi.ferrets.example.comâ€ æ‰§è¡Œï¼šctx.subdomains è¿”å›[â€œferretsâ€, â€œtobiâ€]ï¼Œå¦‚æœapp.subdomainOffsetè®¾ä¸º3ï¼Œåˆ™è¿”å›[â€œtobiâ€]ã€‚</li>
</ul>
<h3 id="app-listen-â€¦-ç›‘å¬ç«¯å£"><a href="#app-listen-â€¦-ç›‘å¬ç«¯å£" class="headerlink" title="app.listen( â€¦ )ç›‘å¬ç«¯å£"></a>app.listen( â€¦ )ç›‘å¬ç«¯å£</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</div><div class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</div><div class="line">app.listen(<span class="number">3000</span>);  <span class="comment">// å¯åŠ¨3000ç«¯å£</span></div><div class="line"><span class="comment">// ç­‰ä»·äº</span></div><div class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</div><div class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</div><div class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</div><div class="line">http.createServer(app.callback()).listen(<span class="number">3000</span>);</div></pre></td></tr></table></figure>
<p>è¿˜æ˜¯ä½¿ç”¨äº†nodeå†…ç½®çš„httpæ¨¡å—</p>
<h3 id="app-callback"><a href="#app-callback" class="headerlink" title="app.callback()"></a>app.callback()</h3><p>æ‰§è¡Œè¿™ä¸ªå‡½æ•°è¿”å›çš„å‡½æ•°å¯ä»¥ç”¨äºå¤„ç†<code>http.createServer()</code>çš„è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªå›è°ƒå‡½æ•°å°†ä½ çš„koaåº”ç”¨æŒ‚è½½åœ¨expressæˆ–è€…Connectåº”ç”¨ä¸­ã€‚</p>
<h3 id="app-use-middleWare"><a href="#app-use-middleWare" class="headerlink" title="app.use(middleWare)"></a>app.use(middleWare)</h3><p>koaä¸­è¿™ä¸ªæ–¹æ³•å¾ˆå¸¸ç”¨äº†ï¼Œå°†ç»™å®šçš„middleWareå½“ä½œä¸­é—´ä»¶åŠ è½½åˆ°åº”ç”¨ä¸­ã€‚<code>middleWare</code>æ¥å—ä¸¤ä¸ªå‚æ•°<code>ctx</code>å’Œ<code>next</code>,ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸Šä¸‹æ–‡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„å›è°ƒã€‚</p>
<h3 id="app-context"><a href="#app-context" class="headerlink" title="app.context"></a>app.context</h3><p><code>app.context</code>æ˜¯middleWareç¬¬ä¸€ä¸ªå‚æ•°ctxå®ä¾‹çš„åŸå‹ã€‚æƒ³è¦ç»™ctxæ·»åŠ å±æ€§ï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘app.contextã€‚å¯¹äºåœ¨åº”ç”¨ç¨‹åºä¸­ç»å¸¸ä½¿ç”¨çš„å±æ€§æˆ–è€…å‡½æ•°ï¼Œè¿™ä¸ªapiéå¸¸æœ‰ç”¨ã€‚ä¸è¿‡ä¸å»ºè®®è¿‡åº¦ä¾èµ–ï¼Œæ¯•ç«Ÿç±»ä¼¼å…¨å±€å˜é‡ï¼Œè€Œå…¨å±€å˜é‡æ˜¯evilçš„ğŸ˜ˆã€‚å®˜ç½‘ç»™çš„ä¾‹å­ï¼Œæ¯”å¦‚æ•°æ®åº“å®ä¾‹å¯ä»¥æŒ‚åœ¨åˆ°ctxä¸Šã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.context.db = db();</div><div class="line">app.use(<span class="keyword">async</span> (ctx) =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(ctx.db);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h3><p>é»˜è®¤æ‰€æœ‰çš„é”™è¯¯éƒ½é€šè¿‡<code>stderr</code>è¾“å‡ºï¼Œå¦‚æœè®¾ç½®äº†<code>app.silent</code>ä¸ºtrueçš„è¯ï¼Œå°±ä¸è¾“å‡ºã€‚å½“err.statusæ˜¯404æˆ–è€…err.exposeç­‰äºtrueï¼Œåˆ™é»˜è®¤ä¸è¾“å‡ºã€‚å¦‚æœæƒ³è‡ªå®šä¹‰é”™è¯¯å¤„ç†é€»è¾‘, å¯ä»¥å®šä¹‰ä¸€ä¸ªã€Œé”™è¯¯äº‹ä»¶ã€æ¥ç›‘å¬ Koa app ä¸­å‘ç”Ÿçš„é”™è¯¯ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.on(<span class="string">'error'</span>, err =&gt;</div><div class="line">  log.error(<span class="string">'server error'</span>, err)</div><div class="line">);</div></pre></td></tr></table></figure>
<p>å½“ req/res å‘¨æœŸä¸­å‡ºç°ä»»ä½•é”™è¯¯ä¸”æ— æ³•å“åº”å®¢æˆ·ç«¯æ—¶ï¼ŒKoa ä¼šæŠŠ <code>Context</code>(ä¸Šä¸‹æ–‡) å®ä¾‹ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™ error äº‹ä»¶ã€‚å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œå¦‚æœè¿˜æ²¡æœ‰æ•°æ®è¿”å›å®¢æˆ·ç«¯ï¼Œkoaä¼šå“åº”500 å†…éƒ¨é”™è¯¯ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”ä¼šè§¦å‘app-levelçš„<code>error</code>äº‹ä»¶ï¼Œå¯ä»¥ç”¨æ¥è®°å½•æ—¥å¿—ã€‚</p>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>ä¸€ä¸ªkoaçš„Contextå°è£…äº†nodeåŸç”Ÿçš„requestå’Œresponseå¯¹è±¡ï¼Œæä¾›äº†ä¸€äº›æ–¹ä¾¿çš„APIä¾›åº”ç”¨ç¨‹åºå¼€å‘ã€‚</p>
<p>éšç€æ¯ä¸ªrequestè¯·æ±‚ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Contextï¼Œå½“ä¸­é—´ä»¶è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šè¢«ä¼šä¼ åˆ°ç»™æ¯ä¸ªä¸­é—´ä»¶çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</div><div class="line">  ctx; <span class="comment">// is the Context</span></div><div class="line">  ctx.request; <span class="comment">// is a koa Request</span></div><div class="line">  ctx.response; <span class="comment">// is a koa Response</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>ctxä¸­çš„å¾ˆå¤šè®¿é—®å™¨å’Œæ–¹æ³•ï¼Œç®€å•ä»£ç†äº†ctx.requestæˆ–è€…ctx.resposne ï¼Œå› ä¸ºæœ‰äº›é«˜é¢‘APIï¼Œç›´æ¥ä»£ç†äº†æ–¹ä¾¿ä½¿ç”¨ã€‚æ¯”å¦‚<code>ctx.type</code>å’Œ<code>ctx.length</code>ä»£ç†äº†responseå¯¹è±¡,<code>ctx.path</code>å’Œ<code>ctx.method</code>ä»£ç†äº†requestå¯¹è±¡ã€‚</p>
<ul>
<li><p>ctx.req nodeçš„requestå¯¹è±¡</p>
</li>
<li><p>ctx.res nodeçš„resposneå¯¹è±¡</p>
<p>   é¿å¼€koaï¼Œè€Œç›´æ¥æ“ä½œnodeåº•å±‚çš„responseå¯¹è±¡è¦é¿å…ã€‚æ¯”å¦‚</p>
<ul>
<li>res.statusCode</li>
<li>res.writeHead()</li>
<li>res.write()</li>
<li>res.end()</li>
</ul>
</li>
<li><p>ctx.request koaçš„requestå¯¹è±¡</p>
</li>
<li><p>cox.response koaçš„responseå¯¹è±¡</p>
</li>
<li><p>ctx.state koaæ¨èæŒ‚è½½æ•°æ®çš„åœ°æ–¹ï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ctx.state.user = <span class="keyword">await</span> User.find(id) ;</div></pre></td></tr></table></figure>
</li>
<li><p>ctx.app åº”ç”¨ç¨‹åºå®ä¾‹</p>
</li>
<li><p>cox.throw è‡ªå®šä¹‰çŠ¶æ€ç å“åº”çš„æ–¹æ³•ã€‚æ¯”å¦‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ctx.throw(403);</div><div class="line">ctx.throw(&apos;name required&apos;, 400);</div><div class="line">ctx.throw(400, &apos;name required&apos;);</div><div class="line">ctx.throw(&apos;something exploded&apos;);</div></pre></td></tr></table></figure>
</li>
<li><p>cox.respond å¦‚ä¸æƒ³ä½¿ç”¨koaå†…ç½®çš„responseå¤„ç†æ–¹æ³•ï¼Œå¯ä»¥è®¾ç½®this.respond=falseï¼Œè·³è¿‡koaé’ˆå¯¹responseçš„é¢„å¤„ç†ï¼Œä½ å¯ä»¥è‡ªå·±è®¾ç½®responseå¯¹è±¡ã€‚ç®—æ˜¯ä¸€ç§hackæ–¹æ³•å§ï¼Œä¸€èˆ¬ä¸å¸¸ç”¨</p>
<p>â€¦â€¦</p>
</li>
</ul>
<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><p>ç®€å•ä»‹ç»ä¸€ä¸‹koaçš„requestå¯¹è±¡ï¼Œä¸€äº›å¸¸ç”¨çš„API</p>
<ul>
<li>request.header è¯·æ±‚å¤´</li>
<li>request.method è¯·æ±‚æ–¹æ³•</li>
<li>request.length è¯·æ±‚å¤´çš„Context-Length</li>
<li>request.originalUrl è·å–requestçš„originalUrl</li>
<li>request.origin origin URLï¼ŒåŒ…æ‹¬ï¼Œprotocolå’Œhost</li>
<li>request.path è¯·æ±‚è·¯å¾„</li>
<li>request.querystring æŸ¥è¯¢å‚æ•° , ä¸åŒ…æ‹¬ï¼Ÿ</li>
<li>request.search åŸå§‹çš„query stringï¼ŒåŒ…æ‹¬ï¼Ÿ</li>
<li>request.query   ç»“æ„åŒ–äº†çš„æŸ¥è¯¢å‚æ•°</li>
</ul>
<p>â€¦.</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p>ç®€å•ä»‹ç»ä¸€ä¸‹koaçš„responseå¯¹è±¡ï¼Œä¸€äº›å¸¸ç”¨çš„API</p>
<ul>
<li>response.header  å“åº”å¯¹è±¡</li>
<li>response.status   å“åº”çŠ¶æ€ï¼Œé»˜è®¤æ— å€¼</li>
<li>response.message  å“åº”æ¶ˆæ¯ï¼Œä¸€èˆ¬å’ŒçŠ¶æ€ç ä¸€èµ·è®¾ç½®</li>
<li>response.length  è®¾ç½®å“åº”çš„å¤§å°</li>
<li>response.body   è¿”å›å“åº”å†…å®¹</li>
<li>response.get(field)   è·å–å“åº”çš„å¤´éƒ¨å­—æ®µ</li>
<li>response.set(field,value)  è®¾ç½®å“åº”å¤´çš„å†…å®¹</li>
<li>response.append(field,value)  è¿½åŠ é¢å¤–çš„å¤´éƒ¨å­—æ®µå†…å®¹</li>
<li>response.redirect( url , [alt] )  é‡å®šå‘ï¼Œå¯ä»¥è‡ªå®šâ€™backâ€™ï¼Œèƒ½æä¾›Referreræ”¯æŒï¼Œæ²¡æœ‰æ—¶ï¼Œå¯ç”¨altæŒ‡å®š</li>
<li>response.lastModified  å¦‚æœå“åº”å¤´éƒ¨åŒ…å«Last-Modifiedï¼Œåˆ™ç”¨Dateå¯¹è±¡è¿”å›</li>
</ul>
<p>â€¦..</p>
<p>å…·ä½“APIå¯ä»¥æŸ¥çœ‹æœ¬æ–‡åé¢çš„å®˜ç½‘é“¾æ¥ã€‚</p>
<p>æœ€åä»‹ç»ä¸€ä¸ªdebugæ¨¡å—çš„ä½¿ç”¨</p>
<p>é€šå¸¸æˆ‘ä»¬å¼€å‘ç¯å¢ƒéœ€è¦ä½¿ç”¨consoleæ¥æ‰“å°è°ƒè¯•ä¸€äº›å†…å®¹ï¼Œä½†æ˜¯ç”Ÿäº§ç¯å¢ƒåˆä¸éœ€è¦è¿™äº›å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨debugæ¨¡å—ï¼Œdebugæ¨¡å—å¯ä»¥å¯¹logè¿›è¡Œåˆ†ç»„ï¼Œè€Œä¸”åªæœ‰è®¾ç½®äº†DEBUGçš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šè¾“å‡ºå†…å®¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install debug</div></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥åœ¨ä»£ç ä¸­å¼•å…¥</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'app'</span>);   <span class="comment">// è¿™é‡Œè‡ªå®šç°å®å“ªä¸€å—DEBUGçš„å†…å®¹</span></div><div class="line">app.use(<span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"> ctx, next </span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> config = ctx.app ;</div><div class="line">    debug(<span class="string">'env: %s'</span>,config.env) ;</div><div class="line">    ctx.body = config.env;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥å¯åŠ¨äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DEBUG=app node index.js</div></pre></td></tr></table></figure>
<p>å‚è€ƒæ–‡æ¡£ï¼š</p>
<p><a href="http://koajs.com/" target="_blank" rel="external">Koa next generation web framework for node.js</a></p>
<p><a href="http://es6.ruanyifeng.com/" target="_blank" rel="external">ECMAScript 6 å…¥é—¨</a></p>

    
  </div>
</article>

</div>


  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">æ”¯æŒä¸€ä¸‹</span>
      <div class="donation-body">
        <div class="tip text-center">æ‰«ä¸€æ‰«ï¼Œæ”¯æŒlcoder</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/qr-wechat.png" alt="">
          </li>
        
          <li class="item">
            <img src="/images/qr-alipay.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>




  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">å…³é—­</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              åšå®¢
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              åˆ†ç±»
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              æ ‡ç­¾
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              å‹é“¾
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              å…³äº
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/RSS/atom.xml"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              æœç´¢
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
  <section class="duoshuo-comments">
    <!-- å¤šè¯´è¯„è®ºæ¡† start -->
    <div class="ds-thread" data-thread-key="" data-title="koaç®€ä»‹" data-url="http://www.maotingfeng.me/2017/03/26/coæ¨¡å—æºç è§£æ/index.html"></div>
    <!-- å¤šè¯´è¯„è®ºæ¡† end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"lcoder"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
